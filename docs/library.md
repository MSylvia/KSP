Calibre library management
==========================

KSP will continuously monitor the Calibre database file for changes.  If you add books, update a book's metadata, or re-
generate its MOBI files, these changes *should* be visible on your device at the next sync, on the _Archived Items_
page.


Supported formats
-----------------

* MOBI, and the equivalent AZW and PRC

    The MOBI files **must** also have the correct ASIN (book id) metadata embedded in them -- otherwise KSP will just
    ignore them. MOBI files generated by Calibre always have the corect ASIN. If you import MOBI books into your Calibre
    library, you **must** re-convert them to MOBI -- the original file will be kept, as `_book_name_.ORIGINAL_MOBI`,
    right next to the new MOBI file.

* PDF files are seen as personal documents (PDOCs) by the Kindle device

    You should make sure the PDFs have the proper metadata in them (title/author).

The integration with Calibre *should* be seamless. If you connect the Kindle with an USB cable to the machine, and let
Calibre see it, it should see the books -- downloaded through KSP -- from its library as being on the device. If you
copy more (supported) books onto the device, the device will see them as having been downloaded through the normal
Kindle Store API.


Generated collections
---------------------

KSP can generate collections based on the books' series and tags. To use them, you need to import these collections into
your device.

Go to [MENU] -> _View Archived Items_ -> _Add Other Device Collections_. You will see a device called _Calibre Library_
-- it's a bogus entry, its record generated by KSP.

After importing the collections from the _Calibre Library_ device:

* for each book series, a new collection will be created on the device with the name of the series

* for each configured tag, a new collection named '{*tag_name*}' will be created on the device; if no books (with valid
     files!) have a given tag, that collection will *not* be created on your device.

The tags to generate collections for are configured in `etc/features.py`, the `collection_tags` option.

The generated collections will contain all the matching books in your Calibre library, whether you have them downloaded
onto your device or not.

If you later add more books into a series, or give them a configured tag, you can just re-import the collections from
the bogus _Calibre Library_ device.


Book updates
------------

If the `download_updated_books` option is set in `etc/features.py`, updating book files in Calibre, for a book already
present on your Kindle, will cause the Kindle to download the new version.

**WARNING**: A side-effect is that you will lose the last-read-position, and any notes and highlights on that book!
Basically the Kindle will behave as if the book has just been downloaded for the first time. I don't think this can
be worked around, because the positions of the annotations are highly dependent on the internal layout if the book,
which usually changes when the book is changed.


Last-read positions
-------------------

Last-read positions for Calibre books are uploaded to KSP and saved locally (in `db/sidecar.sqlite`), so if you read a
Calibre book on the device, delete it, and then download it again, it should re-open to the last read positiion you were
at before.

When using multiple devices with KSP, last-read positions in the books will sync across devices. There is one small
difference from the way Amazon does its last-read sync. Amazon keeps the furthest position ever reached on any device,
even if you go backwards in the book on that device or un-register the device altogheter. KSP however keeps the current
last-read position on all devices, and syncs across devices when one device is currently further along in the book. I
think this is a more useful way for the sync to work.

*Note*: last-read positions for PDOCs are not uploaded by the Kindle devices to Amazon, so they cannot be synced across
devices by KSP either.


Annotations
-----------

Bookmarks, highlights and notes that are added while the Kindle is configured to talk to KSP will be saved in the KSP's
database (`db/sidecar.sqlite`) -- but only for books in your Calibre library. Annotations made *before* configuring the
Kindle to use KSP, even for books in you Calibre library, are not visible to the KSP daemon.

So if you remove a book from the Kindle, and later download it again, the annotations saved to KSP should be present as
well.

Annotations are sync'ed across devices, and adding/modifying/deleting annotations on one device should appear on all
other devices registered with KSP.
